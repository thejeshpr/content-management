<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Viewer</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <style>
    .btn-purple { background-color: #6200ea; color: #ffffff; }
    .btn-purple:hover { background-color: #3700b3; color: #ffffff; }
    blockquote { border-left: 4px solid #6200ea; padding-left: 1rem; margin-left: 0; }
    #markdown-content table { width: 100%; margin-bottom: 1rem; color: #fff; border-collapse: collapse; }
    #markdown-content th, #markdown-content td { padding: 0.75rem; vertical-align: top; border: 1px solid #454d55; }
    #markdown-content img { max-width: 100%; height: auto; }
    #markdown-content a { color: #9e8aff; }

    /* --- NEW: mobile-safe header layout --- */
    .header-actions { white-space: nowrap; } /* prevent button text wrap on larger screens */
    @media (max-width: 576px) {
      .header-title { flex: 1 1 100%; }      /* title block takes full width */
      .header-actions {
        width: 100%;
        margin-top: .5rem;                   /* push actions below title */
        justify-content: flex-start;         /* align left on mobile */
      }
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div id="alert-container"></div>

    <!-- Controls (separate card with header, above heading/subtext) -->
    <div id="controls" class="card mb-3 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Control Pane</span>
        <small class="text-muted" id="controls-hint" aria-live="polite"></small>
      </div>
      <div class="card-body">
        <div class="input-group">
          <input type="text" id="json-url" class="form-control" placeholder="Enter JSON data URL">
          <button id="load-btn" class="btn btn-purple">Load Content</button>
          <a href="#" id="edit-btn" class="btn btn-success">Edit</a>
        </div>
        <div id="loading-message" class="mt-2" style="display:none;">Loading...</div>
      </div>
    </div>

    <!-- Header: heading + subtext + created; right side: Share (always) + Settings gear (conditional) -->
    <!-- NEW: add flex-wrap and helper classes -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
      <div class="me-3 header-title">
        <h1 id="page-heading" class="mb-1"></h1>
        <p id="page-subtext" class="text-muted mb-1"></p>
        <p id="created-time" class="text-muted small mb-0"></p>
      </div>
      <div class="d-flex gap-2 header-actions">
        <button id="share-btn" class="btn btn-outline-light">Share</button>
        <button id="toggle-controls-btn" class="btn btn-outline-secondary" title="Settings" aria-label="Settings">
          &#9881;&nbsp;Settings
        </button>
      </div>
    </div>

    <!-- Content -->
    <div id="content-display" class="card">
      <div class="card-body">
        <div id="markdown-content"></div>
        <hr>
        <p id="footer" class="text-muted small"></p>
      </div>
    </div>
  </div>

  <!-- Deps -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS: unchanged -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const EDITOR_BASE_URL = 'https://objectstorage.us-ashburn-1.oraclecloud.com/n/id5acvcl8mxn/b/bucket-dev-pub/o/html-markdown-editor-v1.html';

      const alertContainer    = document.getElementById('alert-container');
      const controlsCard      = document.getElementById('controls');
      const jsonUrlInput      = document.getElementById('json-url');
      const loadBtn           = document.getElementById('load-btn');
      const editBtn           = document.getElementById('edit-btn');
      const shareBtn          = document.getElementById('share-btn');
      const loadingMsg        = document.getElementById('loading-message');
      const toggleBtn         = document.getElementById('toggle-controls-btn');

      const pageHeadingEl     = document.getElementById('page-heading');
      const pageSubtextEl     = document.getElementById('page-subtext');
      const createdTimeEl     = document.getElementById('created-time');
      const markdownEl        = document.getElementById('markdown-content');
      const footerEl          = document.getElementById('footer');

      const escapeHTML = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      const showAlert = (html, type = 'danger') => {
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible`;
        div.role = 'alert';
        div.innerHTML = `${html}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        alertContainer.appendChild(div);
      };

      const stripDuplicates = (md, heading, subtext) => {
        if (!md) return '';
        let out = md;
        if (heading) {
          const esc = heading.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const hRe = new RegExp(String.raw`^(?:\uFEFF)?\s*#{1,2}\s+${esc}\s*\r?\n`, 'm');
          out = out.replace(hRe, '');
        }
        if (subtext) {
          const escS = subtext.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const sRe = new RegExp(String.raw`^(?:\uFEFF)?\s*${escS}\s*\r?\n`, 'm');
          out = out.replace(sRe, '');
        }
        return out;
      };

      const safeHTML = (md) => DOMPurify.sanitize(marked.parse(md || ''));
      const highlightNow = () => markdownEl.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

      const nothingVariants = [
        'Nothing to see here ðŸ‘€','This space intentionally left dramatic.','Here liesâ€¦ absolutely nothing.',
        '404: Fun not found.','All quiet on the content front.','Still loadingâ€¦ your imagination.',
        'Silence is content too. âœ¨','Air. Just premium air.','If you stare long enough, it still does nothing.',
        'Todayâ€™s special: empty plate.','Behold, the void.','Content took a day off.',
        'Minimalism level: expert.','Itâ€™s not a bug, itâ€™s a vibe.','Congrats! You found the secret nothing.'
      ];

      const params = new URLSearchParams(window.location.search);
      const rawNew = params.get('json-url');
      const rawOld = params.get('json_url');
      const jsonParamVal = (rawNew && rawNew.trim() !== '') ? rawNew : ((rawOld && rawOld.trim() !== '') ? rawOld : '');
      const jsonParamIsMissingOrEmpty = (
        (rawNew === null || rawNew.trim() === '') &&
        (rawOld === null || rawOld.trim() === '')
      );

      const lockParam  = params.get('lock-control');
      const lockVal    = (lockParam || '').toLowerCase();
      const isLockedY  = ['y','1','true','yes','t'].includes(lockVal);
      const isLockedN  = ['n','0','false','no','f'].includes(lockVal);
      const noLockParam = !lockParam;

      if (isLockedN) {
        controlsCard.style.display = 'block';
        toggleBtn.style.display = 'inline-block';
      } else {
        controlsCard.style.display = 'none';
        toggleBtn.style.display = 'none';
      }

      const loadContent = async () => {
        const url = (jsonUrlInput.value || '').trim();
        if (!url) {
          showAlert('Please provide a JSON URL.', 'warning');
          return;
        }
        loadingMsg.style.display = 'block';
        loadBtn.disabled = true;

        try {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText || ''}`.trim());
          const data = await res.json();

          const heading = data.heading || '';
          const subtext = data.subtext || '';
          pageHeadingEl.textContent = heading;
          pageSubtextEl.textContent = subtext;
          createdTimeEl.textContent = data.created_time
            ? `Created: ${new Date(data.created_time).toLocaleString()}`
            : '';
          if (heading) document.title = `${heading} Â· Viewer`;

          const cleaned = stripDuplicates(data.markdown_content || '', heading, subtext);
          markdownEl.innerHTML = safeHTML(cleaned);
          highlightNow();

          footerEl.textContent = data.footer || '';
        } catch (err) {
          const detail = err && (err.message || String(err)) || 'Unknown error';
          const urlHtml = `<code>${escapeHTML((jsonUrlInput.value || '').trim())}</code>`;
          const errHtml = `<code>${escapeHTML(detail)}</code>`;
          showAlert(`Failed to load content.<br>URL: ${urlHtml}<br>Error: ${errHtml}`, 'danger');
          console.error(err);
        } finally {
          loadingMsg.style.display = 'none';
          loadBtn.disabled = false;
        }
      };

      const lockedMode = isLockedY || noLockParam;
      if (!jsonParamIsMissingOrEmpty) {
        jsonUrlInput.value = jsonParamVal;
        loadContent();
      } else if (lockedMode) {
        const msg = nothingVariants[Math.floor(Math.random() * nothingVariants.length)];
        showAlert(msg, 'info');
      }

      loadBtn.addEventListener('click', loadContent);

      toggleBtn.addEventListener('click', () => {
        if (!isLockedN) return;
        const visible = controlsCard.style.display !== 'none';
        controlsCard.style.display = visible ? 'none' : 'block';
      });

      editBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const activeJsonUrl = (jsonUrlInput.value || '').trim() || jsonParamVal;
        const url = new URL(EDITOR_BASE_URL, window.location.href);
        if (activeJsonUrl) url.searchParams.set('json-url', activeJsonUrl);
        window.open(url.toString(), '_blank', 'noopener');
      });

      shareBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const activeJsonUrl = (jsonUrlInput.value || '').trim() || jsonParamVal;
        if (!activeJsonUrl) {
          showAlert('No JSON URL to share.', 'warning');
          return;
        }
        const shareUrl = new URL(window.location.href);
        shareUrl.searchParams.set('json-url', activeJsonUrl);
        shareUrl.searchParams.delete('lock-control');

        const title = pageHeadingEl.textContent || 'Content Viewer';
        const text  = pageSubtextEl.textContent || 'Sharing viewer link';

        try {
          if (navigator.share) {
            await navigator.share({ title, text, url: shareUrl.toString() });
          } else {
            await navigator.clipboard.writeText(shareUrl.toString());
            showAlert('Share link copied to clipboard!', 'success');
          }
        } catch (err) {
          if (err && err.name !== 'AbortError') {
            showAlert('Could not share the link. Try copying it manually.', 'warning');
            console.error(err);
          }
        }
      });
    });
  </script>
</body>
</html>
